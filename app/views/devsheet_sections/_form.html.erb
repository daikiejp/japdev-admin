<%= form_with(model: [category, topic, section], class: "space-y-6") do |form| %>
  <% if section.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
      <h2 class="font-bold mb-2"><%= pluralize(section.errors.count, "個のエラー") %>が発生しました:</h2>
      <ul class="list-disc list-inside">
        <% section.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :title, "タイトル", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_field :title,
                    placeholder: "例: 基本構造、配置とスペース",
                    class:
                      "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" %>
  </div>

  <div>
    <%= form.label :slug, "スラッグ", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_field :slug,
                    placeholder: "例: flexbox",
                    class:
                      "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" %>
  </div>

  <div>
    <%= form.label :description,
               "説明",
               class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_area :description,
                   rows: 2,
                   placeholder: "このセクションの説明",
                   class:
                     "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" %>
  </div>

  <div class="border-t border-gray-200 pt-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold text-gray-900">コードブロック</h3>
      <button
        type="button"
        onclick="addCodeBlock()"
        class="
          px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600
        "
      >
        + コードブロック追加
      </button>
    </div>

    <div id="code-blocks-container" class="space-y-6">
      <%= form.fields_for :devsheet_code_blocks do |cb| %>
        <div
          class="
            code-block-item border-2 border-emerald-200 rounded-lg p-4 bg-white
          "
        >
          <%= cb.hidden_field :_destroy, class: "destroy-field" %>

          <div class="flex justify-between items-center mb-4">
            <h4 class="font-medium text-gray-900">コードブロック</h4>
            <button
              type="button"
              onclick="removeCodeBlock(this)"
              class="
                px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600
              "
            >
              削除
            </button>
          </div>

          <div class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <%= cb.label :title,
                         "タイトル（オプション）",
                         class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= cb.text_field :title,
                              placeholder: "基本的なHTMLテンプレート",
                              class: "w-full px-4 py-2 border border-gray-300 rounded-lg" %>
              </div>
              <div>
                <%= cb.label :filename,
                         "ファイル名（オプション）",
                         class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= cb.text_field :filename,
                              placeholder: "index.html または TABS",
                              class: "w-full px-4 py-2 border border-gray-300 rounded-lg" %>
                <p class="text-xs text-gray-500 mt-1">「TABS」と入力でタブモード</p>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <%= cb.label :language, "言語", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= cb.select :language,
                          %w[
                            html
                            css
                            javascript
                            typescript
                            jsx
                            tsx
                            python
                            ruby
                            java
                            go
                            rust
                            php
                            sql
                            bash
                            json
                            yaml
                            markdown
                          ],
                          { include_blank: "選択してください" },
                          class: "w-full px-4 py-2 border border-gray-300 rounded-lg" %>
              </div>
              <div>
                <%= cb.label :highlight_lines,
                         "ハイライト行（カンマ区切り）",
                         class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= cb.text_field :highlight_lines,
                              value:
                                (
                                  if cb.object.highlight_lines.is_a?(Array)
                                    cb.object.highlight_lines.join(", ")
                                  else
                                    cb.object.highlight_lines
                                  end
                                ),
                              placeholder: "1, 3, 5",
                              class: "w-full px-4 py-2 border border-gray-300 rounded-lg" %>
              </div>
            </div>

            <div>
              <%= cb.label :code, "コード", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= cb.text_area :code,
                           rows: 10,
                           placeholder: "ここにコードを入力...",
                           class:
                             "w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm" %>
            </div>

            <div class="border-t-2 border-blue-200 pt-4 bg-blue-50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <h5 class="font-medium text-blue-900">タブ（複数のコードファイル）</h5>
                <button
                  type="button"
                  onclick="addTab(this)"
                  class="
                    px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600
                  "
                >
                  + タブ追加
                </button>
              </div>

              <div class="tabs-container space-y-3">
                <%= cb.fields_for :devsheet_code_block_tabs do |tab| %>
                  <div class="tab-item border border-blue-300 rounded-lg p-3 bg-white">
                    <%= tab.hidden_field :_destroy, class: "destroy-tab-field" %>
                    <%= tab.hidden_field :position %>

                    <div class="flex justify-between items-center mb-3">
                      <span class="text-sm font-medium text-blue-900">タブ</span>
                      <button
                        type="button"
                        onclick="removeTab(this)"
                        class="
                          px-2 py-1 bg-red-400 text-white rounded text-xs hover:bg-red-500
                        "
                      >
                        削除
                      </button>
                    </div>

                    <div class="grid md:grid-cols-2 gap-3 mb-3">
                      <div>
                        <%= tab.label :label, "ラベル", class: "block text-xs font-medium text-gray-700 mb-1" %>
                        <%= tab.text_field :label,
                                       placeholder: "例: grid.html, style.css",
                                       class: "w-full px-3 py-2 border border-gray-300 rounded text-sm" %>
                      </div>
                      <div>
                        <%= tab.label :language, "言語", class: "block text-xs font-medium text-gray-700 mb-1" %>
                        <%= tab.select :language,
                                   %w[html css javascript typescript jsx tsx],
                                   { include_blank: "選択" },
                                   class: "w-full px-3 py-2 border border-gray-300 rounded text-sm" %>
                      </div>
                    </div>

                    <div>
                      <%= tab.label :code, "コード", class: "block text-xs font-medium text-gray-700 mb-1" %>
                      <%= tab.text_area :code,
                                    rows: 6,
                                    placeholder: "タブのコード...",
                                    class:
                                      "w-full px-3 py-2 border border-gray-300 rounded font-mono text-xs" %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="flex gap-3">
    <%= form.submit "保存して一覧に戻る",
                class:
                  "px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-lg font-medium hover:shadow-lg transition-all cursor-pointer" %>
    <%= link_to "キャンセル",
    devsheet_category_devsheet_topic_path(category, topic),
    class:
      "px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-all" %>
  </div>
<% end %>

<script>
let codeBlockIndex = <%= section.devsheet_code_blocks.size %>;
let tabIndexes = {};

function addCodeBlock() {
  const container = document.getElementById('code-blocks-container');
  const template = `
  <div
    class="code-block-item border-2 border-emerald-200 rounded-lg p-4 bg-white"
  >
    <div class="flex justify-between items-center mb-4">
      <h4 class="font-medium text-gray-900">新しいコードブロック</h4>
      <button
        type="button"
        onclick="removeCodeBlock(this)"
        class="
          px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600
        "
      >
        削除
      </button>
    </div>

    <div class="space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">タイトル</label>
          <input
            type="text"
            name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIndex}][title]"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ファイル名</label>
          <input
            type="text"
            name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIndex}][filename]"
            placeholder="index.html または TABS"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          >
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">言語</label>
          <select
            name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIndex}][language]"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          >
            <option value="">選択してください</option>
            <option value="html">html</option>
            <option value="css">css</option>
            <option value="javascript">javascript</option>
            <option value="typescript">typescript</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ハイライト行</label>
          <input
            type="text"
            name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIndex}][highlight_lines]"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
          >
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">コード</label>
        <textarea
          name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIndex}][code]"
          rows="10"
          class="
            w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm
          "
        ></textarea>
      </div>

      <div class="border-t-2 border-blue-200 pt-4 bg-blue-50 p-4 rounded-lg">
        <div class="flex items-center justify-between mb-3">
          <h5 class="font-medium text-blue-900">タブ</h5>
          <button
            type="button"
            onclick="addTab(this)"
            class="
              px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600
            "
          >
            + タブ追加
          </button>
        </div>
        <div class="tabs-container space-y-3"></div>
      </div>
    </div>
  </div>
  `;

  container.insertAdjacentHTML('beforeend', template);
  tabIndexes[codeBlockIndex] = 0;
  codeBlockIndex++;
}

function addTab(button) {
  const codeBlock = button.closest('.code-block-item');
  const container = codeBlock.querySelector('.tabs-container');
  const codeBlockIdx = Array.from(document.querySelectorAll('.code-block-item')).indexOf(codeBlock);

  if (!tabIndexes[codeBlockIdx]) tabIndexes[codeBlockIdx] = 0;
  const tabIdx = tabIndexes[codeBlockIdx];

  const template = `
  <div class="tab-item border border-blue-300 rounded-lg p-3 bg-white">
    <div class="flex justify-between items-center mb-3">
      <span class="text-sm font-medium text-blue-900">タブ</span>
      <button
        type="button"
        onclick="removeTab(this)"
        class="
          px-2 py-1 bg-red-400 text-white rounded text-xs hover:bg-red-500
        "
      >
        削除
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-3 mb-3">
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">ラベル</label>
        <input
          type="text"
          name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIdx}][devsheet_code_block_tabs_attributes][${tabIdx}][label]"
          placeholder="例: grid.html"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
        >
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">言語</label>
        <select
          name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIdx}][devsheet_code_block_tabs_attributes][${tabIdx}][language]"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
        >
          <option value="">選択</option>
          <option value="html">html</option>
          <option value="css">css</option>
          <option value="javascript">javascript</option>
        </select>
      </div>
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-700 mb-1">コード</label>
      <textarea
        name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIdx}][devsheet_code_block_tabs_attributes][${tabIdx}][code]"
        rows="6"
        class="
          w-full px-3 py-2 border border-gray-300 rounded font-mono text-xs
        "
      ></textarea>
    </div>

    <input
      type="hidden"
      name="devsheet_section[devsheet_code_blocks_attributes][${codeBlockIdx}][devsheet_code_block_tabs_attributes][${tabIdx}][position]"
      value="${tabIdx}"
    >
  </div>
  `;

  container.insertAdjacentHTML('beforeend', template);
  tabIndexes[codeBlockIdx]++;
}

function removeCodeBlock(button) {
  const codeBlock = button.closest('.code-block-item');
  const destroyField = codeBlock.querySelector('.destroy-field');

  if (destroyField) {
    destroyField.value = '1';
    codeBlock.style.display = 'none';
  } else {
    codeBlock.remove();
  }
}

function removeTab(button) {
  const tabItem = button.closest('.tab-item');
  const destroyField = tabItem.querySelector('.destroy-tab-field');

  if (destroyField) {
    destroyField.value = '1';
    tabItem.style.display = 'none';
  } else {
    tabItem.remove();
  }
}
</script>
